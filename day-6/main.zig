const std = @import("std");
const print = std.debug.print;

pub fn main() void {
    const start = std.time.microTimestamp();

    const start_and_direction = findStartAndDirection();
    part1(start_and_direction, true);
    // part2(start_and_direction);

    const end = std.time.microTimestamp();
    const micros = end - start;
    const millis = @as(f32, @floatFromInt(micros)) / 1000;
    print("\nExecution time: {d:.3}ms\n", .{millis});
}

fn part1(start_and_direction: CoordinateAndDirection, with_animation: bool) void {
    var current_coordinate, var current_direction = start_and_direction;

    var visited: [ROWS][COLUMNS]bool = [_][COLUMNS]bool{
        [_]bool{false} ** COLUMNS,
    } ** ROWS;
    while (true) {
        if (with_animation) {
            std.time.sleep(3e7);
            printGridFancy(current_coordinate, &visited);
        }
        const next_coordinate = current_coordinate.getAdjacant(current_direction) orelse break;
        if (next_coordinate.isObstacle()) {
            current_direction = current_direction.turnRight();
            continue;
        }
        current_coordinate = next_coordinate;
        visited[current_coordinate.y][current_coordinate.x] = true;
    }

    var total_visited: u16 = 0;
    for (visited) |row| {
        for (row) |is_cell_visited| {
            if (is_cell_visited) total_visited += 1;
        }
    }

    print("Total visited: {}\n", .{total_visited});
}

fn part2(start_and_direction: CoordinateAndDirection) void {
    var total_loops: u16 = 0;

    for (0..ROWS) |y| {
        for (0..COLUMNS) |x| {
            const extra_obstacle = Coordinate{ .x = x, .y = y };
            if (extra_obstacle.isObstacle()) continue;
            if (std.meta.eql(start_and_direction[0], extra_obstacle)) continue;
            if (isLoop(start_and_direction, extra_obstacle)) {
                total_loops += 1;
            }
        }
    }

    print("Total loops: {}\n", .{total_loops});
}

fn isLoop(start_and_direction: CoordinateAndDirection, extra_obstacle: Coordinate) bool {
    var currrent_coordinate, var current_direction = start_and_direction;

    var made_direction_changes: [ROWS][COLUMNS][4]bool = [_][COLUMNS][4]bool{
        [_][4]bool{
            [_]bool{false} ** 4,
        } ** COLUMNS,
    } ** ROWS;
    while (true) {
        const next_coordinate = currrent_coordinate.getAdjacant(current_direction) orelse return false;
        const is_next_extra_obstacle = std.meta.eql(next_coordinate, extra_obstacle);
        const is_obstacle = next_coordinate.isObstacle() or is_next_extra_obstacle;
        if (is_obstacle) {
            const x, const y = .{ currrent_coordinate.x, currrent_coordinate.y };
            const direction_int = @intFromEnum(current_direction);
            const has_made_direction_change = made_direction_changes[y][x][direction_int];
            if (has_made_direction_change) {
                return true;
            }
            made_direction_changes[y][x][direction_int] = true;
            current_direction = current_direction.turnRight();
            continue;
        }
        currrent_coordinate = next_coordinate;
    }
    unreachable;
}

const MARGIN_Y: isize = 20;
const MARGIN_X: isize = 30;

fn printGridFancy(guard_coordinate: Coordinate, visited: *[ROWS][COLUMNS]bool) void {
    var grid = std.ArrayList(u8).init(std.heap.page_allocator);
    defer grid.deinit();

    const from_row = @max(@as(isize, @intCast(guard_coordinate.y)) - MARGIN_Y, 0);
    const to_row = @min(@as(isize, @intCast(guard_coordinate.y)) + MARGIN_Y, ROWS - 1);
    const from_col_idx = @max(@as(isize, @intCast(guard_coordinate.x)) - MARGIN_X, 0);
    const to_col_idx = @min(@as(isize, @intCast(guard_coordinate.x)) + MARGIN_X, COLUMNS - 1);

    for (from_row..@as(usize, @intCast(to_row)) + 1) |y| {
        for (from_col_idx..@as(usize, @intCast(to_col_idx)) + 1) |x| {
            const coord = Coordinate{ .x = x, .y = y };
            if (coord.isObstacle()) {
                grid.appendSlice("üçå") catch unreachable;
            } else if (std.meta.eql(coord, guard_coordinate)) {
                grid.appendSlice("üëÆ") catch unreachable;
            } else if (visited[y][x]) {
                grid.appendSlice("üü©") catch unreachable;
            } else {
                grid.appendSlice("‚¨õ") catch unreachable;
            }
        }
        grid.append('\n') catch unreachable;
    }

    print("\x1b[2J", .{}); // Clear screen
    print("{s}", .{grid.items});
}

const CoordinateAndDirection = struct { Coordinate, Direction };

const DIRECTION_BY_CHAR = std.StaticStringMap(Direction).initComptime(.{
    .{ "<", .Left },
    .{ "^", .Up },
    .{ ">", .Right },
    .{ "v", .Down },
});

fn findStartAndDirection() CoordinateAndDirection {
    for (0..ROWS) |y| {
        for (0..COLUMNS) |x| {
            const coord = Coordinate{ .x = x, .y = y };
            const direction = DIRECTION_BY_CHAR.get(&[_]u8{coord.getChar()}) orelse continue;
            return .{ coord, direction };
        }
    }
    unreachable;
}

const ROWS: usize = 130;
const COLUMNS: usize = 130;

const Direction = enum(u2) {
    Left,
    Up,
    Right,
    Down,

    fn turnRight(self: Direction) Direction {
        return switch (self) {
            .Left => .Up,
            .Up => .Right,
            .Right => .Down,
            .Down => .Left,
        };
    }
};

const Coordinate = struct {
    x: usize,
    y: usize,

    fn toInputIdx(self: *const Coordinate) usize {
        return self.y * (COLUMNS + 1) + self.x;
    }

    fn getChar(self: *const Coordinate) u8 {
        return input[self.toInputIdx()];
    }

    fn isObstacle(self: *const Coordinate) bool {
        return self.getChar() == '#';
    }

    fn getAdjacant(self: *const Coordinate, direction: Direction) ?Coordinate {
        switch (direction) {
            .Left => {
                if (self.x == 0) return null;
                return Coordinate{ .x = self.x - 1, .y = self.y };
            },
            .Up => {
                if (self.y == 0) return null;
                return Coordinate{ .x = self.x, .y = self.y - 1 };
            },
            .Right => {
                if (self.x + 1 == COLUMNS) return null;
                return Coordinate{ .x = self.x + 1, .y = self.y };
            },
            .Down => {
                if (self.y + 1 == ROWS) return null;
                return Coordinate{ .x = self.x, .y = self.y + 1 };
            },
        }
    }
};

const input =
    \\.......#.........#..............#........................#......#....#............................#..#...............#............
    \\...................#.............................................#...................................#............................
    \\...............#.................................##.........#..........#.....##...#...#.....#....#..................#.............
    \\#.............................................#..#.............#..........#.##.............................................#......
    \\#.........................................................#.....#........................................##.......................
    \\...........#.......#.#...........#....#.#...#......................................#...........................#...##............#
    \\........................................................#..#.....................................#..#................#....#...#...
    \\#.#.....#.........................#...........#.......................................#.......#.....................##............
    \\.......#..........##.....#........#..................................................#.........................................#.#
    \\#.#..............#.#.............................#............#....#...............#.........................#............#..#.#.#
    \\..........................................................#....................................................#..................
    \\.......................#....#...........#.....................#....#...#.......#..............#.......................#...........
    \\..............................#..............#.......#....................................#.....................#...#...#.........
    \\........#.................#...#....##..............#...........................#............................#.................#...
    \\..................#........................................#......#......................................................#........
    \\.............#.................#...#..............................................................................#...#...........
    \\.....................................#..........................................................#.#.#......#.........#............
    \\..........#...................................................................#.........##.......#..#.............................
    \\...#.#....................................#..#...........#.......................................................##...............
    \\........................................................................................................#.........................
    \\.........#...........#......#..............#........#....................#...#......#.............................................
    \\........#....#...............#....................#..........#.....................................#......#......#........#.#.....
    \\........................#..........................#.......#........................#................#......#.....................
    \\......................................#.........................................#............................#....................
    \\...................................#.#...#...........#.........................................#.....................#............
    \\.................#....#.....................................................................#..................#.........#........
    \\...........#...........................................................#.............................#...............#..#.........
    \\..#.....................#.........................................................................................................
    \\....................#....#.#...........................#...........................................#..............#...............
    \\...#...................................................#.............................................#.........#..........#.......
    \\.............................###.....#..#..#......................................................................................
    \\##................#.#.......#..............#.....#...............#..#............#................................................
    \\......#...............................................#.#..#............................#............#.................#..........
    \\........................................#.#...................................................#.....#.............................
    \\#.......#.#.......................#.....#....................................#...................#................................
    \\...##................................................................................................#.....................#......
    \\............#.............#..................#.................#..................................................................
    \\...#..............#..............................................................................#..........#......#..............
    \\...#..#...#................................................#.....................#......#......................#.......#..........
    \\.................#..#........#...............#.#................#......##.................#.................................#.....
    \\#.....#.......#...........................................#..........#..............................#...#.#..#......#.....#.......
    \\....................................#.........#........#..................#.............................................#.........
    \\#...............................#........................#.................................................#.....#................
    \\..#..................................#.......#.....................#..............................................................
    \\........#...#.....................................#......#..............#..#..#..........................#.#....#.................
    \\.............#..........#....#................#.......#..........................................#.....#..........................
    \\.............................................#................................#.........................#...#.....................
    \\.........#........#...................................................................#.......#....#..............................
    \\....................................#.......................#..............#...............................#......................
    \\....#....................#................................#....#...........#.............#........................................
    \\....#...........#...................#.#..................................................#.....................#..................
    \\..........#....................#............#.##...#.......#....#...............#.....#...#.........................#.............
    \\.......#....................................................................................................#.................#...
    \\...............................................................................#......#.................#...#.....................
    \\..................#........#..........#..........................................................................#................
    \\..........................................................................................#.......................................
    \\.#..#...........#.................................##...........................#.....#...................#..#.....................
    \\........................#..#..........................................................#............#..................#..........#
    \\...........#...................................................##...........................#...............................#.....
    \\........#......................................................................................................#..................
    \\........#..#............................#..#...........#..............................#......................#.##...........#....#
    \\........#...#.#..............#...#.....................#....................#.#..............................#....................
    \\.......................................................#....................................................#..#..................
    \\...........................................#......................#................#........................#....................#
    \\.............#...............#................................................................................#...................
    \\..#...#............#.............#.....#........................#............#....................#...............................
    \\.....#...................................................................................................................#........
    \\....................#..#...........#....#.............................................................................#.......#...
    \\..............#......#.........................#...........#...#...........................................#...#..................
    \\..............................#.....#.........................................................#......#.#......#...................
    \\............................................................#...................#.#............................#..................
    \\.............###.#........................................#........................................................#..............
    \\......#................................#...............##.........................................................................
    \\.........#.....#.#.....................#.......................................#...............#..........#....#....#.............
    \\..............................................#....................................#...........................................#..
    \\............#.#..........#........#..#.....#.............#..........#............#......#...................##..........#.........
    \\............#....#...................................#.............................#.........................#....................
    \\.#..................................#....#.........................................................................#..............
    \\.........................#...#...#.................#..................#.............#.#...#...............#.......................
    \\.........#...............................#...........#.............................#...........................#..........#.......
    \\......#..........................#.............#..........#.......................................................................
    \\.......#...............#.........#.............#...............................#..................................................
    \\..#......#....................##...........................................#........................................#.............
    \\..........................#.....#.......................#...........................................................#.#...........
    \\..#....................#.............#................................................................#.#.........................
    \\.........#....................#.....#....#...............#.......................#........#.......................................
    \\..............#...................................................................#................#...#..........................
    \\....................#.....#.......#..#......................................#...........#..................................##....#
    \\.......#.......................................................................#..................................................
    \\......#.............##..........................#..#......................^.......................................................
    \\..............................#..........#...................#.................................#.....................#............
    \\.......................##..........................#.......#..............................#...................................#.#.
    \\................#....................................................................#...............................#.........#..
    \\..........................................#......#.....................................#................#........#................
    \\#......................................#.......................................................#..#...........#...................
    \\.......#.............#..................#..#...#............#.......#.....#.....#.#...............................................
    \\.............................#........#.............#.....#.......#...................................#.#..................#......
    \\.................#......................................................................................#........#..#.............
    \\........................................................................#..............#.....#..............................#.....
    \\....#....#..........................................#......##...#....................#...................#..........#.............
    \\.................##.......................##.#.........#................................................#.........................
    \\.#..............................................#.........................#.#.#..........#.....................................##.
    \\............................................................#..........#....#...................................................#.
    \\....#...........#.............................#.....................#.........#..................#...........................#....
    \\......#.#.......#..#......#........#..#...................#....#..................................................................
    \\............#........................................................................................................#............
    \\.....................................................#..........................................#................#................
    \\...#.......#..#..............#.............................#....................................#.................................
    \\.................##.........#........................#....................................#...............#.#.#...................
    \\................#......#......................#..#..........................................#.....................................
    \\......#..................................................##.#.#........#...........................#.......................#......
    \\........................#............#......#.........#.............#.............................................#.....#.##......
    \\......................#........................................#.......#.........#.................#..#...........#...............
    \\..#.......#.........##..#.#................................................................................#.........#............
    \\........................................................................................#............#...........#................
    \\................#...#....................#..##..#...............#.............................................................#...
    \\...#........#..........................#.....#..........................#....................................#.........#.......##.
    \\.................#...........................#.........#......#............................#.....................#................
    \\...................#..........#....#.......#...................#.............................#..........#.........................
    \\.......#..............#.................................#.........#....................................#.................#....##.#
    \\..................................#.......................#....#..#.........................#....................#................
    \\.....#.........#............#...#.........#........#...................#...#......................#.....#............#............
    \\#.#....#...#........#................................##..........................#.............................##...#....#........
    \\.............##..........##...#......#.......#.#................#.#.......................#.............#.........................
    \\.............#....................................#....................................#..........................................
    \\..................................#..............................#.......................................#................#.......
    \\...................#...............#..............................................................................................
    \\....#........#.................................#........#.....................................#.......#................#........#.
    \\.................#......#.......................................................##.....#..................#.......................
    \\...............#.......................#.#........#...........................................#........#..........................
;
